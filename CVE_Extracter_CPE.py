import requests
import xlsxwriter
import pandas as pd
import os
import re
from urllib.request import Request, urlopen
from urllib.error import URLError, HTTPError
from os import path

def cves_from_nvd(search_uri):
    try:
        urlopen(search_uri)
    except HTTPError as e:
        print('>> The NVD server couldn\'t fulfill the request.')
        print('>> Error code: ', e.code)
    except URLError as e:
        print('>> We failed to reach a server.')
        print('>> Reason: ', e.reason)
    else:
        response = requests.get(search_uri)
        if response.status_code == 200:
            f = open("cpe_cve.txt", "w")
            search_result = response.json()
            if search_result['totalResults'] >= 1:
                cpe_result = search_result['result']['cpes']
                for cve in cpe_result[0]['vulnerabilities']:
                    f.write(cve)
                    f.write("\n")
            f.close()
            print(">> File name cpe_cve.txt is found with results in your project directory")
            print("\n>> Thankyou!")

if __name__ == '__main__':
    print(">> CVE through CPE extractor")
    print("-" * 50)
    cpe_pattern = input(">> Input the exact CPE to extract the CVE, eg:cpe:2.3:a:oracle:jdk:1.8.0:update202:*:*:*:*:*:*: ")
    sub_dic = cves_from_nvd('https://services.nvd.nist.gov/rest/json/cpes/1.0?cpeMatchString={}&addOns=cves'.format(cpe_pattern))